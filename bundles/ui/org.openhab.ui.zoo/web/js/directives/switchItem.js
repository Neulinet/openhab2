// Generated by CoffeeScript 1.9.2
'use strict';
angular.module('ZooLib.directives.switchItem', []).directive('switchItem', function($log, itemService, $rootScope) {
  return {
    restrict: 'E',
    replace: true,
    templateUrl: 'partials/directives/switchItem.html',
    scope: {
      item: '='
    },
    link: function(scope) {
      var getIconClassByTags, handleBroadcast, updateItem;
      scope.local = {
        state: null
      };
      scope.options = {
        cssIconClass: ''
      };
      updateItem = function(newState) {
        scope.options.cssIconClass = getIconClassByTags(scope.item);
        return scope.local.state = newState;
      };
      getIconClassByTags = function(item) {
        if (item.tags == null) {
          return;
        }
        if (item.tags.indexOf('power') >= 0) {
          return 'i-power';
        }
        if (item.tags.indexOf('light') >= 0) {
          return 'i-light-on-small';
        }
        if (item.tags.indexOf('fan') >= 0) {
          return 'i-fan';
        }
      };
      scope.handleChange = function() {
        $log.debug("Switch Item " + scope.item.name + " changed to " + scope.local.state);
        return itemService.sendCommand({
          itemName: scope.item.name
        }, scope.local.state);
      };
      handleBroadcast = function(event, newState) {
        scope.item.state = newState;
        updateItem(newState);
        return $rootScope.$broadcast("updateMasterSwitch/" + scope.item.groupNames[0]);
      };
      scope.$watch('item', function(item) {
        if (item == null) {
          return;
        }
        updateItem(item.state);
        scope.$on("smarthome/command/" + item.name, handleBroadcast);
        return scope.$on("smarthome/update/" + item.name, handleBroadcast);
      });
    }
  };
});
